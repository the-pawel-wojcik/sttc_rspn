from numpy import einsum
from numpy.typing import NDArray
from DePrinceLab.response.intermediates_builders import Intermediates


def get_doubles_residual_aaaa(
    intermediates: Intermediates,
    t1_aa: NDArray,
    t1_bb: NDArray,
    t2_aaaa: NDArray,
    t2_abab: NDArray,
    t2_bbbb: NDArray,
) -> NDArray:
    f_aa = intermediates.f_aa
    g_aaaa = intermediates.g_aaaa
    g_abab = intermediates.g_abab
    g_bbbb = intermediates.g_bbbb
    va = intermediates.va
    vb = intermediates.vb
    oa = intermediates.oa
    ob = intermediates.ob

    # The spin aaaa case.
    contracted_intermediate = -1.0 * einsum('kj,baik->abij', f_aa[oa, oa], t2_aaaa)
    doubles_res_aaaa = contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = einsum('bc,caij->abij', f_aa[va, va], t2_aaaa)
    doubles_res_aaaa += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('kc,baik,cj->abij', f_aa[oa, va], t2_aaaa, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('kc,caij,bk->abij', f_aa[oa, va], t2_aaaa, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    doubles_res_aaaa += einsum('baij->abij', g_aaaa[va, va, oa, oa])
    contracted_intermediate = einsum('kbij,ak->abij', g_aaaa[oa, va, oa, oa], t1_aa)
    doubles_res_aaaa += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    contracted_intermediate = einsum('bacj,ci->abij', g_aaaa[va, va, va, oa], t1_aa)
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    doubles_res_aaaa += 0.5 * einsum('lkij,balk->abij', g_aaaa[oa, oa, oa, oa], t2_aaaa)
    contracted_intermediate = einsum('kbcj,caik->abij', g_aaaa[oa, va, va, oa], t2_aaaa)
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('bkjc,acik->abij', g_abab[va, ob, oa, vb], t2_abab)
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    doubles_res_aaaa += 0.5 * einsum('bacd,cdij->abij', g_aaaa[va, va, va, va], t2_aaaa)
    contracted_intermediate = einsum('lkcj,bail,ck->abij', g_aaaa[oa, oa, va, oa], t2_aaaa, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('lkjc,bail,ck->abij', g_abab[oa, ob, oa, vb], t2_aaaa, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = 0.5 * einsum('lkcj,balk,ci->abij', g_aaaa[oa, oa, va, oa], t2_aaaa, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('lkcj,cail,bk->abij', g_aaaa[oa, oa, va, oa], t2_aaaa, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    contracted_intermediate = einsum('kljc,acil,bk->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    contracted_intermediate = einsum('kbcd,daij,ck->abij', g_aaaa[oa, va, va, va], t2_aaaa, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    contracted_intermediate = einsum('bkdc,daij,ck->abij', g_abab[va, ob, va, vb], t2_aaaa, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('kbcd,daik,cj->abij', g_aaaa[oa, va, va, va], t2_aaaa, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('bkcd,adik,cj->abij', g_abab[va, ob, va, vb], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    contracted_intermediate = 0.5 * einsum('kbcd,ak,cdij->abij', g_aaaa[oa, va, va, va], t1_aa, t2_aaaa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    doubles_res_aaaa += -1.0 * einsum('lkij,al,bk->abij', g_aaaa[oa, oa, oa, oa], t1_aa, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    contracted_intermediate = einsum('kbcj,ak,ci->abij', g_aaaa[oa, va, va, oa], t1_aa, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    doubles_res_aaaa += -1.0 * einsum('bacd,cj,di->abij', g_aaaa[va, va, va, va], t1_aa, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    contracted_intermediate = -0.5 * einsum('lkcd,bail,cdjk->abij', g_aaaa[oa, oa, va, va], t2_aaaa, t2_aaaa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = -0.5 * einsum('lkcd,bail,cdjk->abij', g_abab[oa, ob, va, vb], t2_aaaa, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = -0.5 * einsum('lkdc,bail,dcjk->abij', g_abab[oa, ob, va, vb], t2_aaaa, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    doubles_res_aaaa += 0.250 * einsum('lkcd,balk,cdij->abij', g_aaaa[oa, oa, va, va], t2_aaaa, t2_aaaa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_aaaa += -0.5 * einsum('lkcd,daij,cblk->abij', g_aaaa[oa, oa, va, va], t2_aaaa, t2_aaaa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_aaaa += -0.5 * einsum('lkdc,daij,bclk->abij', g_abab[oa, ob, va, vb], t2_aaaa, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_aaaa += -0.5 * einsum('kldc,daij,bckl->abij', g_abab[oa, ob, va, vb], t2_aaaa, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    contracted_intermediate = einsum('lkcd,dail,cbjk->abij', g_aaaa[oa, oa, va, va], t2_aaaa, t2_aaaa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = einsum('lkdc,dail,bcjk->abij', g_abab[oa, ob, va, vb], t2_aaaa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = einsum('klcd,adil,cbjk->abij', g_abab[oa, ob, va, vb], t2_abab, t2_aaaa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = einsum('lkcd,adil,bcjk->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    doubles_res_aaaa += -0.5 * einsum('lkcd,dalk,cbij->abij', g_aaaa[oa, oa, va, va], t2_aaaa, t2_aaaa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_aaaa += 0.5 * einsum('lkcd,adlk,cbij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_aaaa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_aaaa += 0.5 * einsum('klcd,adkl,cbij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_aaaa, optimize=['einsum_path', (0, 1), (0, 1)])
    contracted_intermediate = einsum('lkcd,bail,ck,dj->abij', g_aaaa[oa, oa, va, va], t2_aaaa, t1_aa, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('lkdc,bail,ck,dj->abij', g_abab[oa, ob, va, vb], t2_aaaa, t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = einsum('lkcd,daij,bl,ck->abij', g_aaaa[oa, oa, va, va], t2_aaaa, t1_aa, t1_aa, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('lkdc,daij,bl,ck->abij', g_abab[oa, ob, va, vb], t2_aaaa, t1_aa, t1_bb, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    doubles_res_aaaa += -0.5 * einsum('lkcd,balk,cj,di->abij', g_aaaa[oa, oa, va, va], t2_aaaa, t1_aa, t1_aa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    contracted_intermediate = einsum('lkcd,dail,bk,cj->abij', g_aaaa[oa, oa, va, va], t2_aaaa, t1_aa, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    contracted_intermediate = einsum('klcd,adil,bk,cj->abij', g_abab[oa, ob, va, vb], t2_abab, t1_aa, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    doubles_res_aaaa += -0.5 * einsum('lkcd,al,bk,cdij->abij', g_aaaa[oa, oa, va, va], t1_aa, t1_aa, t2_aaaa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    contracted_intermediate = -1.0 * einsum('lkcj,al,bk,ci->abij', g_aaaa[oa, oa, va, oa], t1_aa, t1_aa, t1_aa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('kbcd,ak,cj,di->abij', g_aaaa[oa, va, va, va], t1_aa, t1_aa, t1_aa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    doubles_res_aaaa += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    doubles_res_aaaa += einsum('lkcd,al,bk,cj,di->abij', g_aaaa[oa, oa, va, va], t1_aa, t1_aa, t1_aa, t1_aa, optimize=['einsum_path', (0, 1), (0, 3), (0, 2), (0, 1)])

    return doubles_res_aaaa


def get_doubles_residual_abab(
    intermediates: Intermediates,
    t1_aa: NDArray,
    t1_bb: NDArray,
    t2_aaaa: NDArray,
    t2_abab: NDArray,
    t2_bbbb: NDArray,
) -> NDArray:
    f_aa = intermediates.f_aa
    f_bb = intermediates.f_bb
    g_aaaa = intermediates.g_aaaa
    g_abab = intermediates.g_abab
    g_bbbb = intermediates.g_bbbb
    va = intermediates.va
    vb = intermediates.vb
    oa = intermediates.oa
    ob = intermediates.ob

    # The spin aaaa case.
    doubles_res_abab = einsum('kj,abik->abij', f_bb[ob, ob], t2_abab)
    doubles_res_abab += einsum('ki,abkj->abij', f_aa[oa, oa], t2_abab)
    doubles_res_abab += -1.0 * einsum('bc,acij->abij', f_bb[vb, vb], t2_abab)
    doubles_res_abab += -1.0 * einsum('ac,cbij->abij', f_aa[va, va], t2_abab)
    doubles_res_abab += einsum('kc,abik,cj->abij', f_bb[ob, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += einsum('kc,abkj,ci->abij', f_aa[oa, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += einsum('kc,acij,bk->abij', f_bb[ob, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += einsum('kc,ak,cbij->abij', f_aa[oa, va], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -1.0 * einsum('abij->abij', g_abab[va, vb, oa, ob])
    doubles_res_abab += einsum('kbij,ak->abij', g_abab[oa, vb, oa, ob], t1_aa)
    doubles_res_abab += einsum('akij,bk->abij', g_abab[va, ob, oa, ob], t1_bb)
    doubles_res_abab += -1.0 * einsum('abcj,ci->abij', g_abab[va, vb, va, ob], t1_aa)
    doubles_res_abab += -1.0 * einsum('abic,cj->abij', g_abab[va, vb, oa, vb], t1_bb)
    doubles_res_abab += -0.5 * einsum('lkij,ablk->abij', g_abab[oa, ob, oa, ob], t2_abab)
    doubles_res_abab += -0.5 * einsum('klij,abkl->abij', g_abab[oa, ob, oa, ob], t2_abab)
    doubles_res_abab += einsum('kbcj,caik->abij', g_abab[oa, vb, va, ob], t2_aaaa)
    doubles_res_abab += -1.0 * einsum('kbcj,acik->abij', g_bbbb[ob, vb, vb, ob], t2_abab)
    doubles_res_abab += einsum('akcj,cbik->abij', g_abab[va, ob, va, ob], t2_abab)
    doubles_res_abab += einsum('kbic,ackj->abij', g_abab[oa, vb, oa, vb], t2_abab)
    doubles_res_abab += -1.0 * einsum('kaci,cbkj->abij', g_aaaa[oa, va, va, oa], t2_abab)
    doubles_res_abab += einsum('akic,cbjk->abij', g_abab[va, ob, oa, vb], t2_bbbb)
    doubles_res_abab += -0.5 * einsum('abcd,cdij->abij', g_abab[va, vb, va, vb], t2_abab)
    doubles_res_abab += -0.5 * einsum('abdc,dcij->abij', g_abab[va, vb, va, vb], t2_abab)
    doubles_res_abab += einsum('klcj,abil,ck->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkcj,abil,ck->abij', g_bbbb[ob, ob, vb, ob], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkci,ablj,ck->abij', g_aaaa[oa, oa, va, oa], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += einsum('lkic,ablj,ck->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += -0.5 * einsum('lkcj,ablk,ci->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -0.5 * einsum('klcj,abkl,ci->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -0.5 * einsum('lkic,ablk,cj->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += -0.5 * einsum('klic,abkl,cj->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkcj,cail,bk->abij', g_abab[oa, ob, va, ob], t2_aaaa, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += einsum('lkcj,acil,bk->abij', g_bbbb[ob, ob, vb, ob], t2_abab, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -1.0 * einsum('klcj,ak,cbil->abij', g_abab[oa, ob, va, ob], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkic,aclj,bk->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += einsum('lkci,ak,cblj->abij', g_aaaa[oa, oa, va, oa], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -1.0 * einsum('klic,ak,cbjl->abij', g_abab[oa, ob, oa, vb], t1_aa, t2_bbbb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -1.0 * einsum('kbcd,adij,ck->abij', g_abab[oa, vb, va, vb], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('kbcd,adij,ck->abij', g_bbbb[ob, vb, vb, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('kacd,dbij,ck->abij', g_aaaa[oa, va, va, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('akdc,dbij,ck->abij', g_abab[va, ob, va, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += einsum('kbdc,daik,cj->abij', g_abab[oa, vb, va, vb], t2_aaaa, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += einsum('kbcd,adik,cj->abij', g_bbbb[ob, vb, vb, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += einsum('akdc,dbik,cj->abij', g_abab[va, ob, va, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += einsum('kbcd,adkj,ci->abij', g_abab[oa, vb, va, vb], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += einsum('kacd,dbkj,ci->abij', g_aaaa[oa, va, va, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += einsum('akcd,dbjk,ci->abij', g_abab[va, ob, va, vb], t2_bbbb, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += 0.5 * einsum('kbcd,ak,cdij->abij', g_abab[oa, vb, va, vb], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += 0.5 * einsum('kbdc,ak,dcij->abij', g_abab[oa, vb, va, vb], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += 0.5 * einsum('akcd,bk,cdij->abij', g_abab[va, ob, va, vb], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += 0.5 * einsum('akdc,bk,dcij->abij', g_abab[va, ob, va, vb], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkij,al,bk->abij', g_abab[oa, ob, oa, ob], t1_aa, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += einsum('kbcj,ak,ci->abij', g_abab[oa, vb, va, ob], t1_aa, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += einsum('akcj,bk,ci->abij', g_abab[va, ob, va, ob], t1_bb, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += einsum('kbic,ak,cj->abij', g_abab[oa, vb, oa, vb], t1_aa, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += einsum('akic,bk,cj->abij', g_abab[va, ob, oa, vb], t1_bb, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('abdc,cj,di->abij', g_abab[va, vb, va, vb], t1_bb, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += 0.5 * einsum('klcd,abil,cdkj->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += 0.5 * einsum('kldc,abil,dckj->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += 0.5 * einsum('lkcd,abil,cdjk->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t2_bbbb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += 0.5 * einsum('lkcd,ablj,cdik->abij', g_aaaa[oa, oa, va, va], t2_abab, t2_aaaa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += 0.5 * einsum('lkcd,ablj,cdik->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += 0.5 * einsum('lkdc,ablj,dcik->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += -0.250 * einsum('lkcd,ablk,cdij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -0.250 * einsum('lkdc,ablk,dcij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -0.250 * einsum('klcd,abkl,cdij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -0.250 * einsum('kldc,abkl,dcij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += 0.5 * einsum('lkcd,adij,cblk->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += 0.5 * einsum('klcd,adij,cbkl->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += 0.5 * einsum('lkcd,adij,cblk->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t2_bbbb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkcd,dail,cbkj->abij', g_aaaa[oa, oa, va, va], t2_aaaa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkdc,dail,cbjk->abij', g_abab[oa, ob, va, vb], t2_aaaa, t2_bbbb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -1.0 * einsum('klcd,adil,cbkj->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkcd,adil,cbjk->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t2_bbbb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkcd,adlj,cbik->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += -0.5 * einsum('lkcd,dalk,cbij->abij', g_aaaa[oa, oa, va, va], t2_aaaa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += 0.5 * einsum('lkcd,adlk,cbij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += 0.5 * einsum('klcd,adkl,cbij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abab += einsum('klcd,abil,ck,dj->abij', g_abab[oa, ob, va, vb], t2_abab, t1_aa, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkcd,abil,ck,dj->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t1_bb, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkcd,ablj,ck,di->abij', g_aaaa[oa, oa, va, va], t2_abab, t1_aa, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_abab += einsum('lkdc,ablj,ck,di->abij', g_abab[oa, ob, va, vb], t2_abab, t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_abab += einsum('klcd,adij,bl,ck->abij', g_abab[oa, ob, va, vb], t2_abab, t1_bb, t1_aa, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkcd,adij,bl,ck->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t1_bb, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkcd,al,dbij,ck->abij', g_aaaa[oa, oa, va, va], t1_aa, t2_abab, t1_aa, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abab += einsum('lkdc,al,dbij,ck->abij', g_abab[oa, ob, va, vb], t1_aa, t2_abab, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abab += -0.5 * einsum('lkdc,ablk,cj,di->abij', g_abab[oa, ob, va, vb], t2_abab, t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_abab += -0.5 * einsum('kldc,abkl,cj,di->abij', g_abab[oa, ob, va, vb], t2_abab, t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkdc,dail,bk,cj->abij', g_abab[oa, ob, va, vb], t2_aaaa, t1_bb, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkcd,adil,bk,cj->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t1_bb, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('kldc,ak,dbil,cj->abij', g_abab[oa, ob, va, vb], t1_aa, t2_abab, t1_bb, optimize=['einsum_path', (0, 1), (1, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkcd,adlj,bk,ci->abij', g_abab[oa, ob, va, vb], t2_abab, t1_bb, t1_aa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkcd,ak,dblj,ci->abij', g_aaaa[oa, oa, va, va], t1_aa, t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('klcd,ak,dbjl,ci->abij', g_abab[oa, ob, va, vb], t1_aa, t2_bbbb, t1_aa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    doubles_res_abab += -0.5 * einsum('lkcd,al,bk,cdij->abij', g_abab[oa, ob, va, vb], t1_aa, t1_bb, t2_abab, optimize=['einsum_path', (0, 1), (1, 2), (0, 1)])
    doubles_res_abab += -0.5 * einsum('lkdc,al,bk,dcij->abij', g_abab[oa, ob, va, vb], t1_aa, t1_bb, t2_abab, optimize=['einsum_path', (0, 1), (1, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkcj,al,bk,ci->abij', g_abab[oa, ob, va, ob], t1_aa, t1_bb, t1_aa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkic,al,bk,cj->abij', g_abab[oa, ob, oa, vb], t1_aa, t1_bb, t1_bb, optimize=['einsum_path', (0, 1), (1, 2), (0, 1)])
    doubles_res_abab += einsum('kbdc,ak,cj,di->abij', g_abab[oa, vb, va, vb], t1_aa, t1_bb, t1_aa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    doubles_res_abab += einsum('akdc,bk,cj,di->abij', g_abab[va, ob, va, vb], t1_bb, t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_abab += -1.0 * einsum('lkdc,al,bk,cj,di->abij', g_abab[oa, ob, va, vb], t1_aa, t1_bb, t1_bb, t1_aa, optimize=['einsum_path', (0, 1), (1, 3), (0, 2), (0, 1)])

    return doubles_res_abab


def get_doubles_residual_abba(
    intermediates: Intermediates,
    t1_aa: NDArray,
    t1_bb: NDArray,
    t2_aaaa: NDArray,
    t2_abab: NDArray,
    t2_bbbb: NDArray,
) -> NDArray:
    f_aa = intermediates.f_aa
    f_bb = intermediates.f_bb
    g_aaaa = intermediates.g_aaaa
    g_abab = intermediates.g_abab
    g_bbbb = intermediates.g_bbbb
    va = intermediates.va
    vb = intermediates.vb
    oa = intermediates.oa
    ob = intermediates.ob

    doubles_res_abba = -1.0 * einsum('kj,abki->abij', f_aa[oa, oa], t2_abab)
    doubles_res_abba += -1.0 * einsum('ki,abjk->abij', f_bb[ob, ob], t2_abab)
    doubles_res_abba += einsum('bc,acji->abij', f_bb[vb, vb], t2_abab)
    doubles_res_abba += einsum('ac,cbji->abij', f_aa[va, va], t2_abab)
    doubles_res_abba += -1.0 * einsum('kc,abki,cj->abij', f_aa[oa, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -1.0 * einsum('kc,abjk,ci->abij', f_bb[ob, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -1.0 * einsum('kc,acji,bk->abij', f_bb[ob, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -1.0 * einsum('kc,ak,cbji->abij', f_aa[oa, va], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += einsum('abji->abij', g_abab[va, vb, oa, ob])
    doubles_res_abba += -1.0 * einsum('kbji,ak->abij', g_abab[oa, vb, oa, ob], t1_aa)
    doubles_res_abba += -1.0 * einsum('akji,bk->abij', g_abab[va, ob, oa, ob], t1_bb)
    doubles_res_abba += einsum('abjc,ci->abij', g_abab[va, vb, oa, vb], t1_bb)
    doubles_res_abba += einsum('abci,cj->abij', g_abab[va, vb, va, ob], t1_aa)
    doubles_res_abba += 0.5 * einsum('lkji,ablk->abij', g_abab[oa, ob, oa, ob], t2_abab)
    doubles_res_abba += 0.5 * einsum('klji,abkl->abij', g_abab[oa, ob, oa, ob], t2_abab)
    doubles_res_abba += -1.0 * einsum('kbjc,acki->abij', g_abab[oa, vb, oa, vb], t2_abab)
    doubles_res_abba += einsum('kacj,cbki->abij', g_aaaa[oa, va, va, oa], t2_abab)
    doubles_res_abba += -1.0 * einsum('akjc,cbik->abij', g_abab[va, ob, oa, vb], t2_bbbb)
    doubles_res_abba += -1.0 * einsum('kbci,cajk->abij', g_abab[oa, vb, va, ob], t2_aaaa)
    doubles_res_abba += einsum('kbci,acjk->abij', g_bbbb[ob, vb, vb, ob], t2_abab)
    doubles_res_abba += -1.0 * einsum('akci,cbjk->abij', g_abab[va, ob, va, ob], t2_abab)
    doubles_res_abba += 0.5 * einsum('abcd,cdji->abij', g_abab[va, vb, va, vb], t2_abab)
    doubles_res_abba += 0.5 * einsum('abdc,dcji->abij', g_abab[va, vb, va, vb], t2_abab)
    doubles_res_abba += einsum('lkcj,abli,ck->abij', g_aaaa[oa, oa, va, oa], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -1.0 * einsum('lkjc,abli,ck->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -1.0 * einsum('klci,abjl,ck->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += einsum('lkci,abjl,ck->abij', g_bbbb[ob, ob, vb, ob], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += 0.5 * einsum('lkjc,ablk,ci->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += 0.5 * einsum('kljc,abkl,ci->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += 0.5 * einsum('lkci,ablk,cj->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += 0.5 * einsum('klci,abkl,cj->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += einsum('lkjc,acli,bk->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -1.0 * einsum('lkcj,ak,cbli->abij', g_aaaa[oa, oa, va, oa], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += einsum('kljc,ak,cbil->abij', g_abab[oa, ob, oa, vb], t1_aa, t2_bbbb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += einsum('lkci,cajl,bk->abij', g_abab[oa, ob, va, ob], t2_aaaa, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -1.0 * einsum('lkci,acjl,bk->abij', g_bbbb[ob, ob, vb, ob], t2_abab, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += einsum('klci,ak,cbjl->abij', g_abab[oa, ob, va, ob], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += einsum('kbcd,adji,ck->abij', g_abab[oa, vb, va, vb], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += einsum('kbcd,adji,ck->abij', g_bbbb[ob, vb, vb, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += einsum('kacd,dbji,ck->abij', g_aaaa[oa, va, va, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += einsum('akdc,dbji,ck->abij', g_abab[va, ob, va, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -1.0 * einsum('kbcd,adki,cj->abij', g_abab[oa, vb, va, vb], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -1.0 * einsum('kacd,dbki,cj->abij', g_aaaa[oa, va, va, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -1.0 * einsum('akcd,dbik,cj->abij', g_abab[va, ob, va, vb], t2_bbbb, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -1.0 * einsum('kbdc,dajk,ci->abij', g_abab[oa, vb, va, vb], t2_aaaa, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -1.0 * einsum('kbcd,adjk,ci->abij', g_bbbb[ob, vb, vb, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -1.0 * einsum('akdc,dbjk,ci->abij', g_abab[va, ob, va, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -0.5 * einsum('kbcd,ak,cdji->abij', g_abab[oa, vb, va, vb], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -0.5 * einsum('kbdc,ak,dcji->abij', g_abab[oa, vb, va, vb], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -0.5 * einsum('akcd,bk,cdji->abij', g_abab[va, ob, va, vb], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -0.5 * einsum('akdc,bk,dcji->abij', g_abab[va, ob, va, vb], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += einsum('lkji,al,bk->abij', g_abab[oa, ob, oa, ob], t1_aa, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -1.0 * einsum('kbjc,ak,ci->abij', g_abab[oa, vb, oa, vb], t1_aa, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -1.0 * einsum('akjc,bk,ci->abij', g_abab[va, ob, oa, vb], t1_bb, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -1.0 * einsum('kbci,ak,cj->abij', g_abab[oa, vb, va, ob], t1_aa, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -1.0 * einsum('akci,bk,cj->abij', g_abab[va, ob, va, ob], t1_bb, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += einsum('abcd,cj,di->abij', g_abab[va, vb, va, vb], t1_aa, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -0.5 * einsum('lkcd,abli,cdjk->abij', g_aaaa[oa, oa, va, va], t2_abab, t2_aaaa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -0.5 * einsum('lkcd,abli,cdjk->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -0.5 * einsum('lkdc,abli,dcjk->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -0.5 * einsum('klcd,abjl,cdki->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -0.5 * einsum('kldc,abjl,dcki->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -0.5 * einsum('lkcd,abjl,cdik->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t2_bbbb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += 0.250 * einsum('lkcd,ablk,cdji->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += 0.250 * einsum('lkdc,ablk,dcji->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += 0.250 * einsum('klcd,abkl,cdji->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += 0.250 * einsum('kldc,abkl,dcji->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -0.5 * einsum('lkcd,adji,cblk->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -0.5 * einsum('klcd,adji,cbkl->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += -0.5 * einsum('lkcd,adji,cblk->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t2_bbbb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_abba += einsum('lkcd,adli,cbjk->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += einsum('lkcd,dajl,cbki->abij', g_aaaa[oa, oa, va, va], t2_aaaa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += einsum('lkdc,dajl,cbik->abij', g_abab[oa, ob, va, vb], t2_aaaa, t2_bbbb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += einsum('klcd,adjl,cbki->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += einsum('lkcd,adjl,cbik->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t2_bbbb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += 0.5 * einsum('lkcd,dalk,cbji->abij', g_aaaa[oa, oa, va, va], t2_aaaa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -0.5 * einsum('lkcd,adlk,cbji->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += -0.5 * einsum('klcd,adkl,cbji->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_abba += einsum('lkcd,abli,ck,dj->abij', g_aaaa[oa, oa, va, va], t2_abab, t1_aa, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_abba += -1.0 * einsum('lkdc,abli,ck,dj->abij', g_abab[oa, ob, va, vb], t2_abab, t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_abba += -1.0 * einsum('klcd,abjl,ck,di->abij', g_abab[oa, ob, va, vb], t2_abab, t1_aa, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_abba += einsum('lkcd,abjl,ck,di->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t1_bb, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_abba += -1.0 * einsum('klcd,adji,bl,ck->abij', g_abab[oa, ob, va, vb], t2_abab, t1_bb, t1_aa, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abba += einsum('lkcd,adji,bl,ck->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t1_bb, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abba += einsum('lkcd,al,dbji,ck->abij', g_aaaa[oa, oa, va, va], t1_aa, t2_abab, t1_aa, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abba += -1.0 * einsum('lkdc,al,dbji,ck->abij', g_abab[oa, ob, va, vb], t1_aa, t2_abab, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abba += 0.5 * einsum('lkcd,ablk,cj,di->abij', g_abab[oa, ob, va, vb], t2_abab, t1_aa, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abba += 0.5 * einsum('klcd,abkl,cj,di->abij', g_abab[oa, ob, va, vb], t2_abab, t1_aa, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abba += einsum('lkcd,adli,bk,cj->abij', g_abab[oa, ob, va, vb], t2_abab, t1_bb, t1_aa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    doubles_res_abba += einsum('lkcd,ak,dbli,cj->abij', g_aaaa[oa, oa, va, va], t1_aa, t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    doubles_res_abba += einsum('klcd,ak,dbil,cj->abij', g_abab[oa, ob, va, vb], t1_aa, t2_bbbb, t1_aa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    doubles_res_abba += einsum('lkdc,dajl,bk,ci->abij', g_abab[oa, ob, va, vb], t2_aaaa, t1_bb, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abba += einsum('lkcd,adjl,bk,ci->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t1_bb, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abba += einsum('kldc,ak,dbjl,ci->abij', g_abab[oa, ob, va, vb], t1_aa, t2_abab, t1_bb, optimize=['einsum_path', (0, 1), (1, 2), (0, 1)])
    doubles_res_abba += 0.5 * einsum('lkcd,al,bk,cdji->abij', g_abab[oa, ob, va, vb], t1_aa, t1_bb, t2_abab, optimize=['einsum_path', (0, 1), (1, 2), (0, 1)])
    doubles_res_abba += 0.5 * einsum('lkdc,al,bk,dcji->abij', g_abab[oa, ob, va, vb], t1_aa, t1_bb, t2_abab, optimize=['einsum_path', (0, 1), (1, 2), (0, 1)])
    doubles_res_abba += einsum('lkjc,al,bk,ci->abij', g_abab[oa, ob, oa, vb], t1_aa, t1_bb, t1_bb, optimize=['einsum_path', (0, 1), (1, 2), (0, 1)])
    doubles_res_abba += einsum('lkci,al,bk,cj->abij', g_abab[oa, ob, va, ob], t1_aa, t1_bb, t1_aa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    doubles_res_abba += -1.0 * einsum('kbcd,ak,cj,di->abij', g_abab[oa, vb, va, vb], t1_aa, t1_aa, t1_bb, optimize=['einsum_path', (0, 1), (1, 2), (0, 1)])
    doubles_res_abba += -1.0 * einsum('akcd,bk,cj,di->abij', g_abab[va, ob, va, vb], t1_bb, t1_aa, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_abba += einsum('lkcd,al,bk,cj,di->abij', g_abab[oa, ob, va, vb], t1_aa, t1_bb, t1_aa, t1_bb, optimize=['einsum_path', (0, 1), (2, 3), (0, 2), (0, 1)])
    return doubles_res_abba


def get_doubles_residual_baab(
    intermediates: Intermediates,
    t1_aa: NDArray,
    t1_bb: NDArray,
    t2_aaaa: NDArray,
    t2_abab: NDArray,
    t2_bbbb: NDArray,
) -> NDArray:
    f_aa = intermediates.f_aa
    f_bb = intermediates.f_bb
    g_aaaa = intermediates.g_aaaa
    g_abab = intermediates.g_abab
    g_bbbb = intermediates.g_bbbb
    va = intermediates.va
    vb = intermediates.vb
    oa = intermediates.oa
    ob = intermediates.ob

    doubles_res_baab = -1.0 * einsum('kj,baik->abij', f_bb[ob, ob], t2_abab)
    doubles_res_baab += -1.0 * einsum('ki,bakj->abij', f_aa[oa, oa], t2_abab)
    doubles_res_baab += einsum('bc,caij->abij', f_aa[va, va], t2_abab)
    doubles_res_baab += einsum('ac,bcij->abij', f_bb[vb, vb], t2_abab)
    doubles_res_baab += -1.0 * einsum('kc,baik,cj->abij', f_bb[ob, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('kc,bakj,ci->abij', f_aa[oa, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += -1.0 * einsum('kc,caij,bk->abij', f_aa[oa, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('kc,ak,bcij->abij', f_bb[ob, vb], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += einsum('baij->abij', g_abab[va, vb, oa, ob])
    doubles_res_baab += -1.0 * einsum('bkij,ak->abij', g_abab[va, ob, oa, ob], t1_bb)
    doubles_res_baab += -1.0 * einsum('kaij,bk->abij', g_abab[oa, vb, oa, ob], t1_aa)
    doubles_res_baab += einsum('bacj,ci->abij', g_abab[va, vb, va, ob], t1_aa)
    doubles_res_baab += einsum('baic,cj->abij', g_abab[va, vb, oa, vb], t1_bb)
    doubles_res_baab += 0.5 * einsum('lkij,balk->abij', g_abab[oa, ob, oa, ob], t2_abab)
    doubles_res_baab += 0.5 * einsum('klij,bakl->abij', g_abab[oa, ob, oa, ob], t2_abab)
    doubles_res_baab += -1.0 * einsum('bkcj,caik->abij', g_abab[va, ob, va, ob], t2_abab)
    doubles_res_baab += -1.0 * einsum('kacj,cbik->abij', g_abab[oa, vb, va, ob], t2_aaaa)
    doubles_res_baab += einsum('kacj,bcik->abij', g_bbbb[ob, vb, vb, ob], t2_abab)
    doubles_res_baab += einsum('kbci,cakj->abij', g_aaaa[oa, va, va, oa], t2_abab)
    doubles_res_baab += -1.0 * einsum('bkic,cajk->abij', g_abab[va, ob, oa, vb], t2_bbbb)
    doubles_res_baab += -1.0 * einsum('kaic,bckj->abij', g_abab[oa, vb, oa, vb], t2_abab)
    doubles_res_baab += 0.5 * einsum('bacd,cdij->abij', g_abab[va, vb, va, vb], t2_abab)
    doubles_res_baab += 0.5 * einsum('badc,dcij->abij', g_abab[va, vb, va, vb], t2_abab)
    doubles_res_baab += -1.0 * einsum('klcj,bail,ck->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += einsum('lkcj,bail,ck->abij', g_bbbb[ob, ob, vb, ob], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += einsum('lkci,balj,ck->abij', g_aaaa[oa, oa, va, oa], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('lkic,balj,ck->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += 0.5 * einsum('lkcj,balk,ci->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += 0.5 * einsum('klcj,bakl,ci->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += 0.5 * einsum('lkic,balk,cj->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += 0.5 * einsum('klic,bakl,cj->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += einsum('klcj,cail,bk->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += einsum('lkcj,ak,cbil->abij', g_abab[oa, ob, va, ob], t1_bb, t2_aaaa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('lkcj,ak,bcil->abij', g_bbbb[ob, ob, vb, ob], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('lkci,calj,bk->abij', g_aaaa[oa, oa, va, oa], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += einsum('klic,cajl,bk->abij', g_abab[oa, ob, oa, vb], t2_bbbb, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += einsum('lkic,ak,bclj->abij', g_abab[oa, ob, oa, vb], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += einsum('kbcd,daij,ck->abij', g_aaaa[oa, va, va, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += einsum('bkdc,daij,ck->abij', g_abab[va, ob, va, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += einsum('kacd,bdij,ck->abij', g_abab[oa, vb, va, vb], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += einsum('kacd,bdij,ck->abij', g_bbbb[ob, vb, vb, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('bkdc,daik,cj->abij', g_abab[va, ob, va, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('kadc,dbik,cj->abij', g_abab[oa, vb, va, vb], t2_aaaa, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('kacd,bdik,cj->abij', g_bbbb[ob, vb, vb, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('kbcd,dakj,ci->abij', g_aaaa[oa, va, va, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += -1.0 * einsum('bkcd,dajk,ci->abij', g_abab[va, ob, va, vb], t2_bbbb, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += -1.0 * einsum('kacd,bdkj,ci->abij', g_abab[oa, vb, va, vb], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += -0.5 * einsum('bkcd,ak,cdij->abij', g_abab[va, ob, va, vb], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -0.5 * einsum('bkdc,ak,dcij->abij', g_abab[va, ob, va, vb], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -0.5 * einsum('kacd,bk,cdij->abij', g_abab[oa, vb, va, vb], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += -0.5 * einsum('kadc,bk,dcij->abij', g_abab[oa, vb, va, vb], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += einsum('klij,al,bk->abij', g_abab[oa, ob, oa, ob], t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('bkcj,ak,ci->abij', g_abab[va, ob, va, ob], t1_bb, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += -1.0 * einsum('kacj,bk,ci->abij', g_abab[oa, vb, va, ob], t1_aa, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += -1.0 * einsum('bkic,ak,cj->abij', g_abab[va, ob, oa, vb], t1_bb, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('kaic,bk,cj->abij', g_abab[oa, vb, oa, vb], t1_aa, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += einsum('badc,cj,di->abij', g_abab[va, vb, va, vb], t1_bb, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += -0.5 * einsum('klcd,bail,cdkj->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -0.5 * einsum('kldc,bail,dckj->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -0.5 * einsum('lkcd,bail,cdjk->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t2_bbbb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -0.5 * einsum('lkcd,balj,cdik->abij', g_aaaa[oa, oa, va, va], t2_abab, t2_aaaa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -0.5 * einsum('lkcd,balj,cdik->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -0.5 * einsum('lkdc,balj,dcik->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += 0.250 * einsum('lkcd,balk,cdij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += 0.250 * einsum('lkdc,balk,dcij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += 0.250 * einsum('klcd,bakl,cdij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += 0.250 * einsum('kldc,bakl,dcij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += -0.5 * einsum('lkcd,daij,cblk->abij', g_aaaa[oa, oa, va, va], t2_abab, t2_aaaa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -0.5 * einsum('lkdc,daij,bclk->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += -0.5 * einsum('kldc,daij,bckl->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += einsum('kldc,dail,bckj->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baab += einsum('lkcd,dalj,cbik->abij', g_aaaa[oa, oa, va, va], t2_abab, t2_aaaa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += einsum('lkdc,dalj,bcik->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += einsum('klcd,dajl,cbik->abij', g_abab[oa, ob, va, vb], t2_bbbb, t2_aaaa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += einsum('lkcd,dajl,bcik->abij', g_bbbb[ob, ob, vb, vb], t2_bbbb, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += -0.5 * einsum('lkdc,dalk,bcij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += -0.5 * einsum('kldc,dakl,bcij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += 0.5 * einsum('lkcd,dalk,bcij->abij', g_bbbb[ob, ob, vb, vb], t2_bbbb, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baab += -1.0 * einsum('klcd,bail,ck,dj->abij', g_abab[oa, ob, va, vb], t2_abab, t1_aa, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_baab += einsum('lkcd,bail,ck,dj->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t1_bb, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_baab += einsum('lkcd,balj,ck,di->abij', g_aaaa[oa, oa, va, va], t2_abab, t1_aa, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('lkdc,balj,ck,di->abij', g_abab[oa, ob, va, vb], t2_abab, t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baab += einsum('lkcd,daij,bl,ck->abij', g_aaaa[oa, oa, va, va], t2_abab, t1_aa, t1_aa, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('lkdc,daij,bl,ck->abij', g_abab[oa, ob, va, vb], t2_abab, t1_aa, t1_bb, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('klcd,al,bdij,ck->abij', g_abab[oa, ob, va, vb], t1_bb, t2_abab, t1_aa, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_baab += einsum('lkcd,al,bdij,ck->abij', g_bbbb[ob, ob, vb, vb], t1_bb, t2_abab, t1_bb, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_baab += 0.5 * einsum('lkdc,balk,cj,di->abij', g_abab[oa, ob, va, vb], t2_abab, t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baab += 0.5 * einsum('kldc,bakl,cj,di->abij', g_abab[oa, ob, va, vb], t2_abab, t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baab += einsum('kldc,dail,bk,cj->abij', g_abab[oa, ob, va, vb], t2_abab, t1_aa, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_baab += einsum('lkdc,ak,dbil,cj->abij', g_abab[oa, ob, va, vb], t1_bb, t2_aaaa, t1_bb, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_baab += einsum('lkcd,ak,bdil,cj->abij', g_bbbb[ob, ob, vb, vb], t1_bb, t2_abab, t1_bb, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_baab += einsum('lkcd,dalj,bk,ci->abij', g_aaaa[oa, oa, va, va], t2_abab, t1_aa, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baab += einsum('klcd,dajl,bk,ci->abij', g_abab[oa, ob, va, vb], t2_bbbb, t1_aa, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baab += einsum('lkcd,ak,bdlj,ci->abij', g_abab[oa, ob, va, vb], t1_bb, t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baab += 0.5 * einsum('klcd,al,bk,cdij->abij', g_abab[oa, ob, va, vb], t1_bb, t1_aa, t2_abab, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_baab += 0.5 * einsum('kldc,al,bk,dcij->abij', g_abab[oa, ob, va, vb], t1_bb, t1_aa, t2_abab, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_baab += einsum('klcj,al,bk,ci->abij', g_abab[oa, ob, va, ob], t1_bb, t1_aa, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baab += einsum('klic,al,bk,cj->abij', g_abab[oa, ob, oa, vb], t1_bb, t1_aa, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('bkdc,ak,cj,di->abij', g_abab[va, ob, va, vb], t1_bb, t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baab += -1.0 * einsum('kadc,bk,cj,di->abij', g_abab[oa, vb, va, vb], t1_aa, t1_bb, t1_aa, optimize=['einsum_path', (0, 1), (0, 2), (0, 1)])
    doubles_res_baab += einsum('kldc,al,bk,cj,di->abij', g_abab[oa, ob, va, vb], t1_bb, t1_aa, t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (1, 3), (0, 2), (0, 1)])
    return doubles_res_baab


def get_doubles_residual_baba(
    intermediates: Intermediates,
    t1_aa: NDArray,
    t1_bb: NDArray,
    t2_aaaa: NDArray,
    t2_abab: NDArray,
    t2_bbbb: NDArray,
) -> NDArray:
    f_aa = intermediates.f_aa
    f_bb = intermediates.f_bb
    g_aaaa = intermediates.g_aaaa
    g_abab = intermediates.g_abab
    g_bbbb = intermediates.g_bbbb
    va = intermediates.va
    vb = intermediates.vb
    oa = intermediates.oa
    ob = intermediates.ob

    doubles_res_baba = einsum('kj,baki->abij', f_aa[oa, oa], t2_abab)
    doubles_res_baba += einsum('ki,bajk->abij', f_bb[ob, ob], t2_abab)
    doubles_res_baba += -1.0 * einsum('bc,caji->abij', f_aa[va, va], t2_abab)
    doubles_res_baba += -1.0 * einsum('ac,bcji->abij', f_bb[vb, vb], t2_abab)
    doubles_res_baba += einsum('kc,baki,cj->abij', f_aa[oa, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += einsum('kc,bajk,ci->abij', f_bb[ob, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += einsum('kc,caji,bk->abij', f_aa[oa, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += einsum('kc,ak,bcji->abij', f_bb[ob, vb], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('baji->abij', g_abab[va, vb, oa, ob])
    doubles_res_baba += einsum('bkji,ak->abij', g_abab[va, ob, oa, ob], t1_bb)
    doubles_res_baba += einsum('kaji,bk->abij', g_abab[oa, vb, oa, ob], t1_aa)
    doubles_res_baba += -1.0 * einsum('bajc,ci->abij', g_abab[va, vb, oa, vb], t1_bb)
    doubles_res_baba += -1.0 * einsum('baci,cj->abij', g_abab[va, vb, va, ob], t1_aa)
    doubles_res_baba += -0.5 * einsum('lkji,balk->abij', g_abab[oa, ob, oa, ob], t2_abab)
    doubles_res_baba += -0.5 * einsum('klji,bakl->abij', g_abab[oa, ob, oa, ob], t2_abab)
    doubles_res_baba += -1.0 * einsum('kbcj,caki->abij', g_aaaa[oa, va, va, oa], t2_abab)
    doubles_res_baba += einsum('bkjc,caik->abij', g_abab[va, ob, oa, vb], t2_bbbb)
    doubles_res_baba += einsum('kajc,bcki->abij', g_abab[oa, vb, oa, vb], t2_abab)
    doubles_res_baba += einsum('bkci,cajk->abij', g_abab[va, ob, va, ob], t2_abab)
    doubles_res_baba += einsum('kaci,cbjk->abij', g_abab[oa, vb, va, ob], t2_aaaa)
    doubles_res_baba += -1.0 * einsum('kaci,bcjk->abij', g_bbbb[ob, vb, vb, ob], t2_abab)
    doubles_res_baba += -0.5 * einsum('bacd,cdji->abij', g_abab[va, vb, va, vb], t2_abab)
    doubles_res_baba += -0.5 * einsum('badc,dcji->abij', g_abab[va, vb, va, vb], t2_abab)
    doubles_res_baba += -1.0 * einsum('lkcj,bali,ck->abij', g_aaaa[oa, oa, va, oa], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += einsum('lkjc,bali,ck->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += einsum('klci,bajl,ck->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkci,bajl,ck->abij', g_bbbb[ob, ob, vb, ob], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -0.5 * einsum('lkjc,balk,ci->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -0.5 * einsum('kljc,bakl,ci->abij', g_abab[oa, ob, oa, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -0.5 * einsum('lkci,balk,cj->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += -0.5 * einsum('klci,bakl,cj->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += einsum('lkcj,cali,bk->abij', g_aaaa[oa, oa, va, oa], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('kljc,cail,bk->abij', g_abab[oa, ob, oa, vb], t2_bbbb, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkjc,ak,bcli->abij', g_abab[oa, ob, oa, vb], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('klci,cajl,bk->abij', g_abab[oa, ob, va, ob], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkci,ak,cbjl->abij', g_abab[oa, ob, va, ob], t1_bb, t2_aaaa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += einsum('lkci,ak,bcjl->abij', g_bbbb[ob, ob, vb, ob], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('kbcd,daji,ck->abij', g_aaaa[oa, va, va, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('bkdc,daji,ck->abij', g_abab[va, ob, va, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('kacd,bdji,ck->abij', g_abab[oa, vb, va, vb], t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('kacd,bdji,ck->abij', g_bbbb[ob, vb, vb, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += einsum('kbcd,daki,cj->abij', g_aaaa[oa, va, va, va], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += einsum('bkcd,daik,cj->abij', g_abab[va, ob, va, vb], t2_bbbb, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += einsum('kacd,bdki,cj->abij', g_abab[oa, vb, va, vb], t2_abab, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += einsum('bkdc,dajk,ci->abij', g_abab[va, ob, va, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += einsum('kadc,dbjk,ci->abij', g_abab[oa, vb, va, vb], t2_aaaa, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += einsum('kacd,bdjk,ci->abij', g_bbbb[ob, vb, vb, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += 0.5 * einsum('bkcd,ak,cdji->abij', g_abab[va, ob, va, vb], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += 0.5 * einsum('bkdc,ak,dcji->abij', g_abab[va, ob, va, vb], t1_bb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += 0.5 * einsum('kacd,bk,cdji->abij', g_abab[oa, vb, va, vb], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += 0.5 * einsum('kadc,bk,dcji->abij', g_abab[oa, vb, va, vb], t1_aa, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += -1.0 * einsum('klji,al,bk->abij', g_abab[oa, ob, oa, ob], t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += einsum('bkjc,ak,ci->abij', g_abab[va, ob, oa, vb], t1_bb, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += einsum('kajc,bk,ci->abij', g_abab[oa, vb, oa, vb], t1_aa, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += einsum('bkci,ak,cj->abij', g_abab[va, ob, va, ob], t1_bb, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += einsum('kaci,bk,cj->abij', g_abab[oa, vb, va, ob], t1_aa, t1_aa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += -1.0 * einsum('bacd,cj,di->abij', g_abab[va, vb, va, vb], t1_aa, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += 0.5 * einsum('lkcd,bali,cdjk->abij', g_aaaa[oa, oa, va, va], t2_abab, t2_aaaa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += 0.5 * einsum('lkcd,bali,cdjk->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += 0.5 * einsum('lkdc,bali,dcjk->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += 0.5 * einsum('klcd,bajl,cdki->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += 0.5 * einsum('kldc,bajl,dcki->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += 0.5 * einsum('lkcd,bajl,cdik->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t2_bbbb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -0.250 * einsum('lkcd,balk,cdji->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += -0.250 * einsum('lkdc,balk,dcji->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += -0.250 * einsum('klcd,bakl,cdji->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += -0.250 * einsum('kldc,bakl,dcji->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += 0.5 * einsum('lkcd,daji,cblk->abij', g_aaaa[oa, oa, va, va], t2_abab, t2_aaaa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += 0.5 * einsum('lkdc,daji,bclk->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += 0.5 * einsum('kldc,daji,bckl->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkcd,dali,cbjk->abij', g_aaaa[oa, oa, va, va], t2_abab, t2_aaaa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkdc,dali,bcjk->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += -1.0 * einsum('klcd,dail,cbjk->abij', g_abab[oa, ob, va, vb], t2_bbbb, t2_aaaa, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkcd,dail,bcjk->abij', g_bbbb[ob, ob, vb, vb], t2_bbbb, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += -1.0 * einsum('kldc,dajl,bcki->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_baba += 0.5 * einsum('lkdc,dalk,bcji->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += 0.5 * einsum('kldc,dakl,bcji->abij', g_abab[oa, ob, va, vb], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += -0.5 * einsum('lkcd,dalk,bcji->abij', g_bbbb[ob, ob, vb, vb], t2_bbbb, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkcd,bali,ck,dj->abij', g_aaaa[oa, oa, va, va], t2_abab, t1_aa, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baba += einsum('lkdc,bali,ck,dj->abij', g_abab[oa, ob, va, vb], t2_abab, t1_bb, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baba += einsum('klcd,bajl,ck,di->abij', g_abab[oa, ob, va, vb], t2_abab, t1_aa, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkcd,bajl,ck,di->abij', g_bbbb[ob, ob, vb, vb], t2_abab, t1_bb, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkcd,daji,bl,ck->abij', g_aaaa[oa, oa, va, va], t2_abab, t1_aa, t1_aa, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_baba += einsum('lkdc,daji,bl,ck->abij', g_abab[oa, ob, va, vb], t2_abab, t1_aa, t1_bb, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_baba += einsum('klcd,al,bdji,ck->abij', g_abab[oa, ob, va, vb], t1_bb, t2_abab, t1_aa, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkcd,al,bdji,ck->abij', g_bbbb[ob, ob, vb, vb], t1_bb, t2_abab, t1_bb, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_baba += -0.5 * einsum('lkcd,balk,cj,di->abij', g_abab[oa, ob, va, vb], t2_abab, t1_aa, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_baba += -0.5 * einsum('klcd,bakl,cj,di->abij', g_abab[oa, ob, va, vb], t2_abab, t1_aa, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkcd,dali,bk,cj->abij', g_aaaa[oa, oa, va, va], t2_abab, t1_aa, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('klcd,dail,bk,cj->abij', g_abab[oa, ob, va, vb], t2_bbbb, t1_aa, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkcd,ak,bdli,cj->abij', g_abab[oa, ob, va, vb], t1_bb, t2_abab, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('kldc,dajl,bk,ci->abij', g_abab[oa, ob, va, vb], t2_abab, t1_aa, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkdc,ak,dbjl,ci->abij', g_abab[oa, ob, va, vb], t1_bb, t2_aaaa, t1_bb, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('lkcd,ak,bdjl,ci->abij', g_bbbb[ob, ob, vb, vb], t1_bb, t2_abab, t1_bb, optimize=['einsum_path', (0, 3), (1, 2), (0, 1)])
    doubles_res_baba += -0.5 * einsum('klcd,al,bk,cdji->abij', g_abab[oa, ob, va, vb], t1_bb, t1_aa, t2_abab, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_baba += -0.5 * einsum('kldc,al,bk,dcji->abij', g_abab[oa, ob, va, vb], t1_bb, t1_aa, t2_abab, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('kljc,al,bk,ci->abij', g_abab[oa, ob, oa, vb], t1_bb, t1_aa, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('klci,al,bk,cj->abij', g_abab[oa, ob, va, ob], t1_bb, t1_aa, t1_aa, optimize=['einsum_path', (0, 2), (0, 2), (0, 1)])
    doubles_res_baba += einsum('bkcd,ak,cj,di->abij', g_abab[va, ob, va, vb], t1_bb, t1_aa, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_baba += einsum('kacd,bk,cj,di->abij', g_abab[oa, vb, va, vb], t1_aa, t1_aa, t1_bb, optimize=['einsum_path', (0, 1), (1, 2), (0, 1)])
    doubles_res_baba += -1.0 * einsum('klcd,al,bk,cj,di->abij', g_abab[oa, ob, va, vb], t1_bb, t1_aa, t1_aa, t1_bb, optimize=['einsum_path', (0, 2), (2, 3), (0, 2), (0, 1)])
    return doubles_res_baba


def get_doubles_residual_bbbb(
    intermediates: Intermediates,
    t1_aa: NDArray,
    t1_bb: NDArray,
    t2_aaaa: NDArray,
    t2_abab: NDArray,
    t2_bbbb: NDArray,
) -> NDArray:
    f_bb = intermediates.f_bb
    g_aaaa = intermediates.g_aaaa
    g_abab = intermediates.g_abab
    g_bbbb = intermediates.g_bbbb
    va = intermediates.va
    vb = intermediates.vb
    oa = intermediates.oa
    ob = intermediates.ob

    contracted_intermediate = -1.0 * einsum('kj,baik->abij', f_bb[ob, ob], t2_bbbb)
    doubles_res_bbbb = contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = einsum('bc,caij->abij', f_bb[vb, vb], t2_bbbb)
    doubles_res_bbbb += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('kc,baik,cj->abij', f_bb[ob, vb], t2_bbbb, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('kc,caij,bk->abij', f_bb[ob, vb], t2_bbbb, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    doubles_res_bbbb += einsum('baij->abij', g_bbbb[vb, vb, ob, ob])
    contracted_intermediate = einsum('kbij,ak->abij', g_bbbb[ob, vb, ob, ob], t1_bb)
    doubles_res_bbbb += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    contracted_intermediate = einsum('bacj,ci->abij', g_bbbb[vb, vb, vb, ob], t1_bb)
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    doubles_res_bbbb += 0.5 * einsum('lkij,balk->abij', g_bbbb[ob, ob, ob, ob], t2_bbbb)
    contracted_intermediate = -1.0 * einsum('kbcj,caki->abij', g_abab[oa, vb, va, ob], t2_abab)
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    contracted_intermediate = einsum('kbcj,caik->abij', g_bbbb[ob, vb, vb, ob], t2_bbbb)
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    doubles_res_bbbb += 0.5 * einsum('bacd,cdij->abij', g_bbbb[vb, vb, vb, vb], t2_bbbb)
    contracted_intermediate = -1.0 * einsum('klcj,bail,ck->abij', g_abab[oa, ob, va, ob], t2_bbbb, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = einsum('lkcj,bail,ck->abij', g_bbbb[ob, ob, vb, ob], t2_bbbb, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = 0.5 * einsum('lkcj,balk,ci->abij', g_bbbb[ob, ob, vb, ob], t2_bbbb, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = einsum('lkcj,cali,bk->abij', g_abab[oa, ob, va, ob], t2_abab, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('lkcj,cail,bk->abij', g_bbbb[ob, ob, vb, ob], t2_bbbb, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    contracted_intermediate = einsum('kbcd,daij,ck->abij', g_abab[oa, vb, va, vb], t2_bbbb, t1_aa, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    contracted_intermediate = einsum('kbcd,daij,ck->abij', g_bbbb[ob, vb, vb, vb], t2_bbbb, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('kbdc,daki,cj->abij', g_abab[oa, vb, va, vb], t2_abab, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('kbcd,daik,cj->abij', g_bbbb[ob, vb, vb, vb], t2_bbbb, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    contracted_intermediate = 0.5 * einsum('kbcd,ak,cdij->abij', g_bbbb[ob, vb, vb, vb], t1_bb, t2_bbbb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    doubles_res_bbbb += -1.0 * einsum('lkij,al,bk->abij', g_bbbb[ob, ob, ob, ob], t1_bb, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    contracted_intermediate = einsum('kbcj,ak,ci->abij', g_bbbb[ob, vb, vb, ob], t1_bb, t1_bb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    doubles_res_bbbb += -1.0 * einsum('bacd,cj,di->abij', g_bbbb[vb, vb, vb, vb], t1_bb, t1_bb, optimize=['einsum_path', (0, 1), (0, 1)])
    contracted_intermediate = -0.5 * einsum('klcd,bail,cdkj->abij', g_abab[oa, ob, va, vb], t2_bbbb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = -0.5 * einsum('kldc,bail,dckj->abij', g_abab[oa, ob, va, vb], t2_bbbb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = -0.5 * einsum('lkcd,bail,cdjk->abij', g_bbbb[ob, ob, vb, vb], t2_bbbb, t2_bbbb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    doubles_res_bbbb += 0.250 * einsum('lkcd,balk,cdij->abij', g_bbbb[ob, ob, vb, vb], t2_bbbb, t2_bbbb, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += -0.5 * einsum('lkcd,daij,cblk->abij', g_abab[oa, ob, va, vb], t2_bbbb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += -0.5 * einsum('klcd,daij,cbkl->abij', g_abab[oa, ob, va, vb], t2_bbbb, t2_abab, optimize=['einsum_path', (0, 2), (0, 1)])
    doubles_res_bbbb += -0.5 * einsum('lkcd,daij,cblk->abij', g_bbbb[ob, ob, vb, vb], t2_bbbb, t2_bbbb, optimize=['einsum_path', (0, 2), (0, 1)])
    contracted_intermediate = einsum('lkcd,dali,cbkj->abij', g_aaaa[oa, oa, va, va], t2_abab, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = einsum('lkdc,dali,cbjk->abij', g_abab[oa, ob, va, vb], t2_abab, t2_bbbb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = einsum('klcd,dail,cbkj->abij', g_abab[oa, ob, va, vb], t2_bbbb, t2_abab, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = einsum('lkcd,dail,cbjk->abij', g_bbbb[ob, ob, vb, vb], t2_bbbb, t2_bbbb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    doubles_res_bbbb += 0.5 * einsum('lkdc,dalk,cbij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_bbbb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_bbbb += 0.5 * einsum('kldc,dakl,cbij->abij', g_abab[oa, ob, va, vb], t2_abab, t2_bbbb, optimize=['einsum_path', (0, 1), (0, 1)])
    doubles_res_bbbb += -0.5 * einsum('lkcd,dalk,cbij->abij', g_bbbb[ob, ob, vb, vb], t2_bbbb, t2_bbbb, optimize=['einsum_path', (0, 1), (0, 1)])
    contracted_intermediate = -1.0 * einsum('klcd,bail,ck,dj->abij', g_abab[oa, ob, va, vb], t2_bbbb, t1_aa, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = einsum('lkcd,bail,ck,dj->abij', g_bbbb[ob, ob, vb, vb], t2_bbbb, t1_bb, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('klcd,daij,bl,ck->abij', g_abab[oa, ob, va, vb], t2_bbbb, t1_bb, t1_aa, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    contracted_intermediate = einsum('lkcd,daij,bl,ck->abij', g_bbbb[ob, ob, vb, vb], t2_bbbb, t1_bb, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    doubles_res_bbbb += -0.5 * einsum('lkcd,balk,cj,di->abij', g_bbbb[ob, ob, vb, vb], t2_bbbb, t1_bb, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    contracted_intermediate = einsum('lkdc,dali,bk,cj->abij', g_abab[oa, ob, va, vb], t2_abab, t1_bb, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    contracted_intermediate = einsum('lkcd,dail,bk,cj->abij', g_bbbb[ob, ob, vb, vb], t2_bbbb, t1_bb, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate)  - einsum('abij->baij', contracted_intermediate)  + einsum('abij->baji', contracted_intermediate) 
    doubles_res_bbbb += -0.5 * einsum('lkcd,al,bk,cdij->abij', g_bbbb[ob, ob, vb, vb], t1_bb, t1_bb, t2_bbbb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    contracted_intermediate = -1.0 * einsum('lkcj,al,bk,ci->abij', g_bbbb[ob, ob, vb, ob], t1_bb, t1_bb, t1_bb, optimize=['einsum_path', (0, 3), (0, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->abji', contracted_intermediate) 
    contracted_intermediate = -1.0 * einsum('kbcd,ak,cj,di->abij', g_bbbb[ob, vb, vb, vb], t1_bb, t1_bb, t1_bb, optimize=['einsum_path', (0, 2), (1, 2), (0, 1)])
    doubles_res_bbbb += contracted_intermediate - einsum('abij->baij', contracted_intermediate) 
    doubles_res_bbbb += einsum('lkcd,al,bk,cj,di->abij', g_bbbb[ob, ob, vb, vb], t1_bb, t1_bb, t1_bb, t1_bb, optimize=['einsum_path', (0, 3), (2, 3), (0, 2), (0, 1)])
    return doubles_res_bbbb
